<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Publisher</title>
  <style>
    body { font-family: system-ui, Segoe UI, Arial, sans-serif; margin: 24px; }
    video { width: 60vw; max-width: 960px; background: #000; }
    label { display: inline-block; min-width: 80px; }
  </style>
</head>
<body>
  <h1>推流（Publisher）</h1>
  <div>
    <label>房间:</label>
    <input id="room" value="demo" />
    <button id="start">开始推流</button>
  </div>
  <p id="log"></p>
  <video id="preview" autoplay playsinline muted></video>

  <script>
    const log = (m) => { document.getElementById('log').textContent = m; console.log(m); };
    const startBtn = document.getElementById('start');
    const roomInput = document.getElementById('room');
    const preview = document.getElementById('preview');

    async function start() {
      startBtn.disabled = true;
      const room = roomInput.value || 'demo';
      const pc = new RTCPeerConnection({
        iceServers: [{ urls: ['stun:stun.l.google.com:19302'] }]
      });
      pc.onconnectionstatechange = () => log('PC state: ' + pc.connectionState);

      const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      preview.srcObject = stream;
      for (const track of stream.getTracks()) {
        pc.addTrack(track, stream);
      }

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);

      const resp = await fetch(`/api/whip/publish/${encodeURIComponent(room)}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/sdp' },
        body: offer.sdp,
      });
      if (!resp.ok) {
        log('服务器错误: ' + await resp.text());
        return;
      }
      const answerSDP = await resp.text();
      await pc.setRemoteDescription({ type: 'answer', sdp: answerSDP });
      log('推流已建立');
    }

    startBtn.onclick = start;
  </script>
</body>
</html>
